<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: Arial, sans-serif; 
      background: #f0f0f0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }
    h1 { text-align: center; margin-bottom: 20px; color: #333; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, button {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      background: #4285f4;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background: #3367d6; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .loader {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4285f4;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      display: none;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìù –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h1>
    <form id="form">
      <div class="form-group">
        <label for="taskName">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:</label>
        <input type="text" id="taskName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
      </div>
      
      <div class="form-group">
        <label for="lastDate">–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
        <input type="date" id="lastDate" required>
      </div>
      
      <div class="form-group">
        <label for="photo">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
        <input type="file" id="photo" accept="image/*">
      </div>
      
      <button type="submit" id="submit-btn">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </form>
    
    <div class="loader" id="loader">
      <div class="spinner"></div>
      <div>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏...</div>
    </div>
    
    <div id="message" class="message"></div>
  </div>

  <script>
    // –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô URL Google Apps Script!
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyqoWyOUNomqOb8l-fwXI-S1nndj6UnkbIxNorjrLgY-jgUfShHOB-6aHYk2OGJCJCwlA/exec';
    
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('form');
      const submitBtn = document.getElementById('submit-btn');
      const loader = document.getElementById('loader');
      const messageDiv = document.getElementById('message');
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('lastDate').value = today;
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
      function showMessage(text, isError = false) {
        messageDiv.textContent = text;
        messageDiv.className = isError ? 'error' : 'success';
        messageDiv.style.display = 'block';
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 5000);
      }
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const taskName = document.getElementById('taskName').value.trim();
        const lastDate = document.getElementById('lastDate').value;
        const fileInput = document.getElementById('photo');
        
        if (!taskName || !lastDate) {
          showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∏ –¥–∞—Ç—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.', true);
          return;
        }
        
        submitBtn.disabled = true;
        loader.style.display = 'block';
        messageDiv.style.display = 'none';
        
        try {
          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç DD.MM.YYYY
          const dateParts = lastDate.split('-');
          const formattedDate = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;
          
          // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
          const formData = {
            taskName: taskName,
            lastDate: formattedDate // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–∞—Ç—É
          };
          
          // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
          if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const base64Data = await readFileAsBase64(file);
            formData.base64 = base64Data;
            formData.mimeType = file.type;
            formData.fileName = file.name;
          }
          
          console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', formData);
          
          // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å mode: 'no-cors' –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º nocache
          const response = await fetch(SCRIPT_URL + '?nocache=' + Date.now(), {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
          });
          
          // –ü—Ä–∏ mode: 'no-cors' –º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç, –Ω–æ –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
          console.log('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (no-cors mode)');
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç –ø—Ä–∏ no-cors)
          showMessage('‚úÖ –ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
          form.reset();
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É —Å–Ω–æ–≤–∞
          document.getElementById('lastDate').value = today;
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞:', error);
          showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + error.message, true);
        } finally {
          loader.style.display = 'none';
          submitBtn.disabled = false;
        }
      });
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∫–∞–∫ base64
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(evt) {
          resolve(evt.target.result);
        };
        reader.onerror = function() {
          reject(new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞'));
        };
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
